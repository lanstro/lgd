Lgd.module("Entities", function(Entities, Lgd, Backbone, Marionette, $, _){

	Entities.Container = Backbone.Model.extend ({
		
		initialize: function(){
			this.set('shortContent', this.shortContent());
			this.set('calcID', this.calcID());
			var children = this.get("children");
			if(children){
				this.children = new Entities.ContainerCollection(children);
				this.unset("children");
			}
			
		},
		
		calcID: function(){
			if(this.get('level') <= <%= SECTION %>){
				return ["", "Ch", "Pt", "Div", "Subdiv", "s"][this.get('level')]+this.get('number');
			}
			else {
				return this.get('id');
			}
		},
		
		shortContent: function(){
			if(this.get('level') < <%= SECTION %> || 
			   this.get('content').length < 40 ){
				return this.get('content');
			}
			return this.get('content').substring(0, 40)+"...";
		},
		
		aliases: function(){
			if(this.get('level') >= <%= PARA_LIST_HEAD %>){
				return null;
			}
			var result = [];
			var num = null;
			if(this.get('level') <= <%= SECTION %>){
				num = this.get('number');
			}
			else {
				num = this.subsectionCitation();
			}
			var num_start = /\d/.test(num[0]);
			_.each(<%= STRUCTURAL_ALIASES.values %>[this.get('level')], function(name){
				result.push(name+" "+num);
				if(num_start){
					result.push(name+num);
				}
			});
			result.push(num);
			return result;
		},
		
		parent: function(){
			return Lgd.view.collection.findParent(this);
		},
		
		subsectionCitation: function(current){
			if(typeof(current)==='undefined') current=this;
			if(current.get('level') >= <%= PARA_LIST_HEAD %> || 
				 current.get('level') <  <%= SECTION %> ){
				return null;
			}
			result="";
			while(current.get('level') > <%= SECTION %>) {
				if(current.get('number') != null) {
					result = "("+current.get('number')+")"+result;
				}
				current=current.parent();
			}
			result=current.get('number')+result;
			return result;
		}
	});

	Entities.ContainerCollection = Backbone.Collection.extend({
		model: Entities.Container,
		comparator: 'position',
		initialize: function(){
			this.url=$('#legislation_main').data('legislation_id')+'/containers_json.json';
		},
		
	});
	
	Entities.Comment = Backbone.Model.extend ({
		initialize: function(){
			var children = this.get("children");
			if(children){
				this.children = new Entities.CommentsCollection(children);
				this.set({"showForm": false});
				this.unset("children");
			}
		},
	});
	
	Entities.CommentsCollection = Backbone.Collection.extend({
		model: Entities.Comment,
		comparator: 'reputation',
	});
	
	var act;
	
	var initialize=function(){
		if(act===undefined)
			act = new Entities.ContainerCollection();
	};
	
	var API = {
		getAct: function(){
			if(act===undefined){
				initialize();
			}
			return act;
		},
	};
	
	Lgd.reqres.setHandler("Act", function(){
		return API.getAct();
	});
	
	
});